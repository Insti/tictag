#!/bin/bash
set -xeuf pipefail

docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
docker push $IMAGE

ssh $DEPLOY_USER@$DEPLOY_HOST docker pull $IMAGE

ssh $DEPLOY_USER@$DEPLOY_HOST docker kill tictag || echo "ok"
ssh $DEPLOY_USER@$DEPLOY_HOST docker rm tictag || echo "ok"
ssh $DEPLOY_USER@$DEPLOY_HOST docker run \
    --net=host \
    --name=tictag \
    -e SLACK_VERIFICATION_TOKEN=$SLACK_VERIFICATION_TOKEN \
    -e PG_USER=$PG_USER \
    -e PG_PASSWORD=$PG_PASSWORD \
    -e PG_DATABASE=$PG_DATABASE \
    -e TICTAG_PORT=$TICTAG_PORT \
    -e TICTAG_CRYPTO_KEY=$TICTAG_CRYPTO_KEY \
    -e EC_PRIV_KEY="$EC_PRIV_KEY" \
    -e EC_PUB_KEY="$EC_PUB_KEY" \
    --restart always \
    --detach \
    $IMAGE
